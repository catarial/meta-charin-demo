From f9f281d76767b21291af923e50994761a8ab90bd Mon Sep 17 00:00:00 2001
From: Aria Nolan <aria@chytrid.org>
Date: Thu, 7 Nov 2024 10:18:26 -0700
Subject: [PATCH] rollback uMWC BSP to 2024.6.0

---
 .../board_support/evse_board_supportImpl.cpp     | 16 ++++++++++------
 .../board_support/evse_board_supportImpl.hpp     |  2 ++
 .../dc_supply/power_supply_DCImpl.cpp            |  5 ++---
 .../dc_supply/power_supply_DCImpl.hpp            |  3 +--
 4 files changed, 15 insertions(+), 11 deletions(-)

diff --git a/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.cpp b/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.cpp
index 9d39772e..05ba66db 100644
--- a/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.cpp
+++ b/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.cpp
@@ -42,7 +42,7 @@ static types::board_support_common::BspEvent cast_event_type(bool relais_state)
 
 void evse_board_supportImpl::init() {
     {
-        std::scoped_lock lock(capsMutex);
+        std::lock_guard<std::mutex> lock(capsMutex);
 
         caps.min_current_A_import = 0;
         caps.max_current_A_import = 100;
@@ -83,11 +83,15 @@ void evse_board_supportImpl::init() {
 }
 
 void evse_board_supportImpl::ready() {
-    {
-        // Publish caps once in the beginning
-        std::scoped_lock lock(capsMutex);
-        publish_capabilities(caps);
-    }
+}
+
+void evse_board_supportImpl::handle_setup(bool& three_phases, bool& has_ventilation, std::string& country_code) {
+    // your code for cmd setup goes here
+}
+
+types::evse_board_support::HardwareCapabilities evse_board_supportImpl::handle_get_hw_capabilities() {
+    std::lock_guard<std::mutex> lock(capsMutex);
+    return caps;
 }
 
 void evse_board_supportImpl::handle_enable(bool& value) {
diff --git a/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.hpp b/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.hpp
index 42c8620e..daa58f1f 100644
--- a/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.hpp
+++ b/modules/MicroMegaWattBSP/board_support/evse_board_supportImpl.hpp
@@ -34,6 +34,8 @@ public:
 
 protected:
     // command handler functions (virtual)
+    virtual void handle_setup(bool& three_phases, bool& has_ventilation, std::string& country_code) override;
+    virtual types::evse_board_support::HardwareCapabilities handle_get_hw_capabilities() override;
     virtual void handle_enable(bool& value) override;
     virtual void handle_pwm_on(double& value) override;
     virtual void handle_pwm_off() override;
diff --git a/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.cpp b/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.cpp
index 1b543320..98c25326 100644
--- a/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.cpp
+++ b/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.cpp
@@ -42,10 +42,9 @@ void power_supply_DCImpl::ready() {
     publish_capabilities(caps);
 }
 
-void power_supply_DCImpl::handle_setMode(types::power_supply_DC::Mode& mode,
-                                         types::power_supply_DC::ChargingPhase& phase) {
+void power_supply_DCImpl::handle_setMode(types::power_supply_DC::Mode& value) {
     // your code for cmd setMode goes here
-    if (mode == types::power_supply_DC::Mode::Export) {
+    if (value == types::power_supply_DC::Mode::Export) {
         mod->serial.setOutputVoltageCurrent(req_voltage, req_current);
         is_on = true;
     } else {
diff --git a/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.hpp b/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.hpp
index e89fdfe8..820d81fe 100644
--- a/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.hpp
+++ b/modules/MicroMegaWattBSP/dc_supply/power_supply_DCImpl.hpp
@@ -33,8 +33,7 @@ public:
 
 protected:
     // command handler functions (virtual)
-    virtual void handle_setMode(types::power_supply_DC::Mode& mode,
-                                types::power_supply_DC::ChargingPhase& phase) override;
+    virtual void handle_setMode(types::power_supply_DC::Mode& value) override;
     virtual void handle_setExportVoltageCurrent(double& voltage, double& current) override;
     virtual void handle_setImportVoltageCurrent(double& voltage, double& current) override;
 
-- 
2.47.0

